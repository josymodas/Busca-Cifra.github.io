<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cifr√°rio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Fira Mono', monospace;
      background-color: #121212;
      color: #fff;
      font-size: 1em;
    }
    .light-mode {
      background-color: #f5f5f5;
      color: #000;
    }
    .light-mode #cifraDisplay {
      background-color: #fff;
      color: #000;
    }
    .container {
      max-width: 600px;
      margin: 2em auto;
      padding: 1em;
      background: #1f1f1f;
      border-radius: 10px;
    }
    .light-mode .container {
      background: #ffffff;
      color: #000000;
    }
    h1, h2, h3 {
      text-align: center;
    }
    input, button, select, textarea {
      width: 100%;
      padding: 0.8em;
      margin-top: 1em;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-family: inherit;
      box-sizing: border-box;
    }
    button {
      background-color: #333;
      color: white;
      cursor: pointer;
    }
    .light-mode button {
      background-color: #ddd;
      color: #000;
    }
    button:hover {
      background-color: #555;
    }
    .light-mode button:hover {
      background-color: #ccc;
    }
    #cifraDisplay {
      white-space: pre-wrap;
      background: #222;
      padding: 1.5em;
      border-radius: 8px;
      margin-top: 1em;
      font-size: 1.1em;
      font-weight: 400;
      min-height: 250px;
    }
    .cifra-line {
      display: block;
      white-space: pre;
    }
    .acorde {
      color: #00bfff;
      font-weight: bold;
    }
    #toggleBtn {
      position: fixed;
      bottom: 1em;
      right: 1em;
      font-size: 1.8em;
      cursor: pointer;
      background-color: #00000088;
      padding: 0.3em 0.6em;
      border-radius: 50px;
      z-index: 1000;
      color: #fff;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    #toggleBtn:hover {
      opacity: 1;
    }
    .controls {
      display: none;
      position: fixed;
      top: 1em;
      left: 1em;
      background-color: #00000066;
      padding: 0.5em;
      border-radius: 10px;
      z-index: 999;
      flex-direction: column;
      gap: 0.5em;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 0.5em;
      font-size: 0.95em;
      color: inherit;
    }
    .transpose-controls {
      margin: 1em 0;
      text-align: center;
    }
    .transpose-controls button {
      width: auto;
      margin: 0 0.5em;
    }
  </style>
</head>
<body>
  <!-- Bot√£o flutuante -->
  <div id="toggleBtn" onclick="alternarControles()">‚öôÔ∏è</div>
  <div class="controls">
    <button onclick="toggleMode()">üåó Tema</button>
    <button onclick="adjustFont(1)">A+</button>
    <button onclick="adjustFont(-1)">A‚àí</button>
    <button onclick="toggleScroll()">‚ñ∂Ô∏è Rolagem</button>
    <div class="slider-container">
      <label for="scrollSpeed">Velocidade:</label>
      <input type="range" id="scrollSpeed" min="1" max="10" value="2" oninput="atualizarPorcentagem()">
      <span id="scrollPercent">20%</span>
    </div>
  </div>

  <!-- App -->
  <div class="container">
    <h1>üé∏ Cifr√°rio</h1>
    <input type="text" id="usuario" placeholder="Usu√°rio">
    <input type="password" id="senha" placeholder="Senha">
    <button onclick="logar()">Entrar</button>

    <div id="mainApp" style="display:none;">
      <h2 id="bemVindo"></h2>
      <button onclick="logout()">Sair</button>

      <div id="adminPanel" style="display:none;">
        <h3>üëë Gerenciar Usu√°rios</h3>
        <button onclick="adicionarUsuario()">‚ûï Adicionar usu√°rio</button>
        <div id="listaUsuarios"></div>
      </div>

      <label>URL da cifra:</label>
      <input type="text" id="urlCifra" placeholder="Cole a URL da cifra">
      <button onclick="extrairCifra()">üîç Extrair</button>

      <label>T√≠tulo da m√∫sica:</label>
      <input type="text" id="titulo">
      <textarea id="conteudo" rows="6" placeholder="Cole a cifra..."></textarea>
      <button onclick="salvarCifra()">üíæ Salvar cifra</button>

      <div class="transpose-controls">
        <label for="tomAtual">Tom:</label>
        <select id="tomAtual" onchange="transporPara(this.value)">
          <option value="">-- Selecione --</option>
          <option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option>
          <option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option>
        </select>
        <br><br>
        <button onclick="transpor(-1)">‚ô≠ Meio tom abaixo</button>
        <button onclick="transpor(1)">‚ôØ Meio tom acima</button>
      </div>

      <h3>Minhas cifras</h3>
      <select id="lista" onchange="carregarCifra()">
        <option value="">-- Selecione --</option>
      </select>
      <button onclick="removerCifra()">üóëÔ∏è Remover selecionada</button>

      <div style="display: flex; gap: 1em; margin-top: 1em;">
        <button onclick="copiarCifra()">üìã Copiar</button>
        <button onclick="exportarPDF()">üìÑ PDF</button>
      </div>

      <div id="cifraDisplay"></div>
    </div>
  </div>
<script>
  const usuariosKey = "usuarios";
  const sessaoKey = "usuarioAtual";
  let scrollInterval;
  let tomAtual = 0;

  const notas = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

  function iniciarSistema() {
    const usuarios = JSON.parse(localStorage.getItem(usuariosKey)) || {};
    if (!usuarios["Cifrario"]) {
      usuarios["Cifrario"] = { senha: "4321", tipo: "master" };
      localStorage.setItem(usuariosKey, JSON.stringify(usuarios));
    }
    const logado = localStorage.getItem(sessaoKey);
    if (logado) mostrarApp(logado);
  }

  function logar() {
    const usuario = document.getElementById("usuario").value.trim();
    const senha = document.getElementById("senha").value;
    const usuarios = JSON.parse(localStorage.getItem(usuariosKey)) || {};
    if (usuarios[usuario] && usuarios[usuario].senha === senha) {
      localStorage.setItem(sessaoKey, usuario);
      mostrarApp(usuario);
    } else {
      alert("Usu√°rio ou senha inv√°lidos");
    }
  }

  function mostrarApp(usuario) {
    document.getElementById("mainApp").style.display = "block";
    document.getElementById("bemVindo").innerText = `Bem-vindo, ${usuario}`;
    const usuarios = JSON.parse(localStorage.getItem(usuariosKey));
    if (usuarios[usuario]?.tipo === "master") {
      document.getElementById("adminPanel").style.display = "block";
      listarUsuarios();
    }
    atualizarLista();
  }

  function logout() {
    localStorage.removeItem(sessaoKey);
    location.reload();
  }

  function salvarCifra() {
    const usuario = localStorage.getItem(sessaoKey);
    const titulo = document.getElementById("titulo").value.trim();
    const conteudo = document.getElementById("conteudo").value;
    if (!titulo || !conteudo) return alert("Preencha os campos.");
    localStorage.setItem(`cifra_${usuario}_${titulo}`, conteudo);
    atualizarLista();
    document.getElementById("cifraDisplay").innerHTML = formatarCifra(conteudo);
  }

  function atualizarLista() {
    const usuario = localStorage.getItem(sessaoKey);
    const lista = document.getElementById("lista");
    lista.innerHTML = '<option value="">-- Selecione --</option>';
    for (let i = 0; i < localStorage.length; i++) {
      const chave = localStorage.key(i);
      if (chave.startsWith(`cifra_${usuario}_`)) {
        const titulo = chave.replace(`cifra_${usuario}_`, "");
        const op = document.createElement("option");
        op.value = titulo;
        op.text = titulo;
        lista.appendChild(op);
      }
    }
  }

  function carregarCifra() {
    const usuario = localStorage.getItem(sessaoKey);
    const titulo = document.getElementById("lista").value;
    const cifra = localStorage.getItem(`cifra_${usuario}_${titulo}`);
    document.getElementById("titulo").value = titulo;
    document.getElementById("conteudo").value = cifra || "";
    document.getElementById("cifraDisplay").innerHTML = formatarCifra(cifra || "");
    tomAtual = 0;
  }

  function removerCifra() {
    const usuario = localStorage.getItem(sessaoKey);
    const titulo = document.getElementById("lista").value;
    if (!titulo) return;
    if (confirm(`Remover "${titulo}"?`)) {
      localStorage.removeItem(`cifra_${usuario}_${titulo}`);
      atualizarLista();
      document.getElementById("cifraDisplay").textContent = "";
    }
  }

  function adicionarUsuario() {
    const nome = prompt("Novo nome de usu√°rio:").trim();
    const senha = prompt("Senha para esse usu√°rio:").trim();
    if (!nome || !senha) return alert("Preenchimento obrigat√≥rio.");
    const usuarios = JSON.parse(localStorage.getItem(usuariosKey)) || {};
    if (usuarios[nome]) return alert("Usu√°rio j√° existe.");
    usuarios[nome] = { senha, tipo: "normal" };
    localStorage.setItem(usuariosKey, JSON.stringify(usuarios));
    listarUsuarios();
    alert("Usu√°rio criado!");
  }

  function listarUsuarios() {
    const usuarios = JSON.parse(localStorage.getItem(usuariosKey)) || {};
    const div = document.getElementById("listaUsuarios");
    div.innerHTML = "<h4>Usu√°rios cadastrados:</h4>";
    Object.keys(usuarios).forEach(nome => {
      if (nome !== "Cifrario") {
        const btn = `<button onclick="removerUsuario('${nome}')">Remover ${nome}</button>`;
        div.innerHTML += `<div>${nome} ${btn}</div>`;
      }
    });
  }

  function removerUsuario(nome) {
    const usuarios = JSON.parse(localStorage.getItem(usuariosKey)) || {};
    if (!usuarios[nome]) return alert("Usu√°rio n√£o existe.");
    delete usuarios[nome];
    localStorage.setItem(usuariosKey, JSON.stringify(usuarios));
    listarUsuarios();
    alert("Usu√°rio removido.");
  }

  async function extrairCifra() {
    const url = document.getElementById("urlCifra").value.trim();
    if (!url) return alert("Informe a URL da cifra.");
    try {
      const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const pre = doc.querySelector("pre");
      const titulo = doc.querySelector("title")?.innerText?.split(" - ")[0]?.trim() || "Sem t√≠tulo";
      if (!pre) return alert("N√£o foi poss√≠vel extrair a cifra.");
      document.getElementById("titulo").value = titulo;
      document.getElementById("conteudo").value = pre.innerText;
      salvarCifra();
      alert("Cifra extra√≠da e salva!");
    } catch (e) {
      alert("Erro ao extrair cifra: " + e.message);
    }
  }

  function transpor(semitons) {
    tomAtual += semitons;
    const cifra = document.getElementById("conteudo").value;
    document.getElementById("cifraDisplay").innerHTML = formatarCifra(cifra, tomAtual);
  }

  function transporPara(tomDestino) {
    if (!tomDestino) return;
    const cifra = document.getElementById("conteudo").value;
    const base = notas.indexOf("C");
    const alvo = notas.indexOf(tomDestino);
    tomAtual = alvo - base;
    document.getElementById("cifraDisplay").innerHTML = formatarCifra(cifra, tomAtual);
  }

  function formatarCifra(texto, deslocamento = 0) {
    return texto.split('\n').map(linha => {
      const tokens = linha.split(/(\s+)/).map(t => {
        const match = t.trim().match(/^([A-G][b#]?)(.*)/);
        if (match) {
          const [_, nota, resto] = match;
          let idx = notas.indexOf(nota);
          if (idx >= 0) {
            idx = (idx + deslocamento + 12) % 12;
            return `<span class='acorde'>${notas[idx]}${resto}</span>`;
          }
        }
        return t;
      }).join('');
      return `<span class='cifra-line'>${tokens}</span>`;
    }).join('\n');
  }

  function copiarCifra() {
    const texto = document.getElementById("cifraDisplay").innerText;
    navigator.clipboard.writeText(texto).then(() => alert("Cifra copiada!"));
  }

  function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const texto = document.getElementById("cifraDisplay").innerText;
    const titulo = document.getElementById("titulo")?.value || "Cifra";
    doc.text(texto, 10, 10);
    doc.save(`${titulo}.pdf`);
  }

  function toggleMode() {
    document.body.classList.toggle('light-mode');
  }

  function adjustFont(delta) {
    const currentSize = parseFloat(window.getComputedStyle(document.body).fontSize);
    document.body.style.fontSize = (currentSize + delta) + 'px';
  }

  function toggleScroll() {
    if (scrollInterval) pararRolagem();
    else iniciarRolagem();
  }

  function iniciarRolagem() {
    const speed = parseInt(document.getElementById("scrollSpeed").value);
    pararRolagem();
    scrollInterval = setInterval(() => {
      window.scrollBy(0, speed);
    }, 100);
  }

  function pararRolagem() {
    clearInterval(scrollInterval);
    scrollInterval = null;
  }

  function alternarControles() {
    const painel = document.querySelector('.controls');
    painel.style.display = painel.style.display === 'flex' ? 'none' : 'flex';
  }

  function atualizarPorcentagem() {
    const valor = document.getElementById("scrollSpeed").value;
    const porcentagem = valor * 10;
    document.getElementById("scrollPercent").textContent = porcentagem + '%';
  }

  iniciarSistema();
</script>
</body>
</html>
