<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#121212">
  <title>Cifr√°rio</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Fira Mono', monospace;
      background: #121212;
      color: white;
      overflow-x: hidden;
    }
    .light-mode {
      background: #f0f0f0;
      color: #000;
    }
    .light-mode textarea, .light-mode input, .light-mode select {
      background: #fff;
      color: #000;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 1em;
    }
    input, textarea, select, button {
      width: 100%;
      margin-top: 0.5em;
      padding: 0.8em;
      border-radius: 5px;
      border: none;
      font-family: inherit;
    }
    button {
      background: #444;
      color: white;
    }
    button:hover {
      background: #666;
    }
    #cifraDisplay {
      background: #1f1f1f;
      border-radius: 10px;
      padding: 1em;
      margin-top: 1em;
      white-space: pre-wrap;
      font-size: 1em;
    }
    .acorde {
      color: #00bfff;
      font-weight: normal;
    }
    .letra {
      font-weight: bold;
    }
    .floating-btn {
      position: fixed;
      bottom: 1em;
      right: 1em;
      z-index: 1000;
      background: #000000cc;
      color: white;
      border-radius: 50%;
      padding: 0.7em 1em;
      font-size: 1.5em;
      cursor: pointer;
    }
    .config-panel {
      position: fixed;
      top: 1em;
      right: 1em;
      background: #222;
      padding: 1em;
      border-radius: 10px;
      display: none;
      flex-direction: column;
      gap: 0.5em;
      z-index: 999;
    }
    .visible { display: flex !important; }
  </style>
</head>
<body>
  <div class="container" id="loginContainer">
    <h2>üîê Login</h2>
    <input type="text" id="loginUser" placeholder="Usu√°rio">
    <input type="password" id="loginPass" placeholder="Senha">
    <button onclick="login()">Entrar</button>
  </div>

  <div class="container" id="appContainer" style="display:none">
    <h1>üé∏ Cifr√°rio</h1>
    <label>Extrair de URL:</label>
    <input type="url" id="urlInput" placeholder="Cole a URL da cifra...">
    <button onclick="extrairURL()">üîç Extrair da URL</button>

    <label>Nova m√∫sica:</label>
    <input type="text" id="titulo" placeholder="T√≠tulo da m√∫sica">
    <textarea id="cifra" rows="10" placeholder="Cole aqui a cifra..."></textarea>

    <label>Tom:</label>
    <select id="controleTom" onchange="transporTom(this.value)">
      <option value="0">Original</option>
      ${[...Array(12).keys()].map(n => `<option value="${n}">+${n}</option>`).join('')}
      ${[...Array(12).keys()].map(n => `<option value="-${n+1}">-${n+1}</option>`).join('')}
    </select>

    <button onclick="salvarCifra()">üíæ Salvar</button>
    <h3>üéµ Minhas m√∫sicas</h3>
    <select id="listaMusicas" onchange="carregarCifra()">
      <option>-- Selecione --</option>
    </select>
    <button onclick="removerCifra()">üóëÔ∏è Remover m√∫sica selecionada</button>

    <div id="adminPanel" style="display:none">
      <h3>üë§ Usu√°rios</h3>
      <select id="listaUsuarios" onchange="selecionarUsuario()"></select>
      <button onclick="removerUsuario()">‚ùå Remover Usu√°rio</button>
    </div>

    <button onclick="logout()">üö™ Sair</button>
    <div style="display:flex; gap:1em; margin-top:1em;">
      <button onclick="copiarCifra()">üìã Copiar</button>
      <button onclick="baixarPDF()">üìÑ PDF</button>
    </div>
    <div id="cifraDisplay"></div>
  </div>
  <div id="configBtn" class="floating-btn" onclick="toggleConfig()">‚öôÔ∏è</div>
  <div id="configPanel" class="config-panel">
    <button onclick="toggleTheme()">üåì Tema</button>
    <button onclick="rolarCifra()">‚¨áÔ∏è Rolar</button>
  </div>

  <script>
    const cifraDisplay = document.getElementById("cifraDisplay");
    const storageKey = "cifrarioData";
    const usersKey = "cifrarioUsers";
    const defaultUser = { username: "Cifrario", password: "4321", isMaster: true };

    let currentUser = null;

    const notas = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

    function transporTom(quant) {
      if (!quant) return;
      const texto = document.getElementById("cifra").value;
      const nova = texto.replace(/[A-G][#b]?(m|dim|aug|sus|add)?\d*(\/[A-G][#b]?)?/g, acorde => {
        const raiz = acorde.match(/[A-G][#b]?/)[0];
        const resto = acorde.slice(raiz.length);
        let i = notas.indexOf(raiz);
        if (i < 0) return acorde;
        i = (i + parseInt(quant) + 12) % 12;
        return notas[i] + resto;
      });
      document.getElementById("cifra").value = nova;
      exibirCifra(nova);
    }

    function exibirCifra(texto) {
      const linhas = texto.split("\n").map(linha => {
        const tokens = linha.split(/(\s+)/).map(t => /^[A-G][#b]?(m|dim|aug|sus|add)?\d*(\/[A-G][#b]?)?$/.test(t) ?
          `<span class="acorde">${t}</span>` : `<span class="letra">${t}</span>`);
        return tokens.join('');
      }).join('\n');
      cifraDisplay.innerHTML = linhas;
    }

    function salvarCifra() {
      const titulo = document.getElementById("titulo").value;
      const cifra = document.getElementById("cifra").value;
      if (!titulo || !cifra || !currentUser) return;
      let dados = JSON.parse(localStorage.getItem(storageKey) || "{}");
      if (!dados[currentUser.username]) dados[currentUser.username] = {};
      dados[currentUser.username][titulo] = cifra;
      localStorage.setItem(storageKey, JSON.stringify(dados));
      atualizarLista();
      exibirCifra(cifra);
    }

    function carregarCifra() {
      const titulo = document.getElementById("listaMusicas").value;
      if (!titulo || !currentUser) return;
      const dados = JSON.parse(localStorage.getItem(storageKey) || "{}");
      const cifra = dados[currentUser.username]?.[titulo] || "";
      document.getElementById("titulo").value = titulo;
      document.getElementById("cifra").value = cifra;
      exibirCifra(cifra);
    }

    function atualizarLista() {
      const lista = document.getElementById("listaMusicas");
      lista.innerHTML = "<option>-- Selecione --</option>";
      const dados = JSON.parse(localStorage.getItem(storageKey) || "{}");
      const musicas = dados[currentUser.username] || {};
      Object.keys(musicas).forEach(m => {
        const opt = document.createElement("option");
        opt.value = opt.text = m;
        lista.appendChild(opt);
      });
    }

    function removerCifra() {
      const titulo = document.getElementById("listaMusicas").value;
      const dados = JSON.parse(localStorage.getItem(storageKey) || "{}");
      delete dados[currentUser.username]?.[titulo];
      localStorage.setItem(storageKey, JSON.stringify(dados));
      atualizarLista();
    }

    function login() {
      const u = document.getElementById("loginUser").value;
      const p = document.getElementById("loginPass").value;
      const lista = JSON.parse(localStorage.getItem(usersKey) || "[]");
      if (!lista.length) lista.push(defaultUser);
      const user = lista.find(x => x.username === u && x.password === p);
      if (user) {
        currentUser = user;
        localStorage.setItem("cifrarioSession", u);
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("appContainer").style.display = "block";
        if (user.isMaster) carregarUsuarios();
        atualizarLista();
      } else {
        alert("Usu√°rio ou senha inv√°lido");
      }
    }

    function logout() {
      localStorage.removeItem("cifrarioSession");
      location.reload();
    }

    function carregarUsuarios() {
      const lista = JSON.parse(localStorage.getItem(usersKey) || "[]");
      const sel = document.getElementById("listaUsuarios");
      sel.innerHTML = "";
      lista.forEach(u => {
        if (!u.isMaster) {
          const opt = document.createElement("option");
          opt.value = u.username;
          opt.text = u.username;
          sel.appendChild(opt);
        }
      });
      document.getElementById("adminPanel").style.display = "block";
    }

    function removerUsuario() {
      const usuario = document.getElementById("listaUsuarios").value;
      let lista = JSON.parse(localStorage.getItem(usersKey) || "[]");
      lista = lista.filter(u => u.username !== usuario);
      localStorage.setItem(usersKey, JSON.stringify(lista));
      carregarUsuarios();
    }

    function copiarCifra() {
      navigator.clipboard.writeText(document.getElementById("cifraDisplay").innerText);
      alert("Cifra copiada!");
    }

    function baixarPDF() {
      import("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js").then(({ jsPDF }) => {
        const doc = new jsPDF();
        doc.text(document.getElementById("cifraDisplay").innerText, 10, 10);
        doc.save((document.getElementById("titulo").value || "cifra") + ".pdf");
      });
    }

    function toggleTheme() {
      document.body.classList.toggle("light-mode");
    }

    function toggleConfig() {
      document.getElementById("configPanel").classList.toggle("visible");
    }

    function rolarCifra() {
      cifraDisplay.scrollBy({ top: 200, behavior: "smooth" });
    }

    function extrairURL() {
      const url = document.getElementById("urlInput").value;
      if (!url) return;
      fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(url))
        .then(res => res.json())
        .then(data => {
          const html = data.contents;
          const matches = html.match(/<pre[^>]*>([\s\S]*?)<\/pre>/);
          if (matches) {
            const cifra = matches[1]
              .replace(/<br\s*\/?>/gi, "\n")
              .replace(/<\/?[^>]+(>|$)/g, "");
            document.getElementById("cifra").value = cifra.trim();
            exibirCifra(cifra.trim());
          } else {
            alert("Cifra n√£o encontrada.");
          }
        })
        .catch(() => alert("Erro ao buscar a cifra."));
    }

    window.onload = () => {
      const u = localStorage.getItem("cifrarioSession");
      const users = JSON.parse(localStorage.getItem(usersKey) || "[]");
      if (!users.length) localStorage.setItem(usersKey, JSON.stringify([defaultUser]));
      if (u) {
        const user = users.find(x => x.username === u);
        if (user) {
          currentUser = user;
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("appContainer").style.display = "block";
          if (user.isMaster) carregarUsuarios();
          atualizarLista();
        }
      }
    };
  </script>

  <script>
    // Service Worker para PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log("SW registrado:", reg.scope))
        .catch(err => console.error("Erro SW:", err));
    }
  </script>
</body>
</html>
